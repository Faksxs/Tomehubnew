
-- Safe Session Integrity Repair
-- 1. DELETE Orphaned/Invalid Records
-- Since we found 0 valid matches, we perform a cleanup of invalid data 
-- to allow type conversion.
DELETE FROM TOMEHUB_FLOW_SEEN WHERE NOT REGEXP_LIKE(SESSION_ID, '^[0-9]+$') OR SESSION_ID NOT IN (SELECT TO_CHAR(ID) FROM TOMEHUB_CHAT_SESSIONS);

DELETE FROM TOMEHUB_SEARCH_LOGS WHERE NOT REGEXP_LIKE(SESSION_ID, '^[0-9]+$') OR SESSION_ID NOT IN (SELECT TO_CHAR(ID) FROM TOMEHUB_CHAT_SESSIONS);

COMMIT;

-- 2. Alter Columns to NUMBER
-- Now that data is clean (likely empty or valid), we can convert.
BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE TOMEHUB_FLOW_SEEN MODIFY (SESSION_ID NUMBER)';
EXCEPTION
    WHEN OTHERS THEN NULL; -- Ignore if already number (idempotent-ish)
END;
/

BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE TOMEHUB_SEARCH_LOGS MODIFY (SESSION_ID NUMBER)';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

-- 3. Add Foreign Keys (Enforce Integrity)
BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE TOMEHUB_FLOW_SEEN ADD CONSTRAINT fk_flow_session FOREIGN KEY (SESSION_ID) REFERENCES TOMEHUB_CHAT_SESSIONS(ID) ON DELETE CASCADE';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE TOMEHUB_SEARCH_LOGS ADD CONSTRAINT fk_search_session FOREIGN KEY (SESSION_ID) REFERENCES TOMEHUB_CHAT_SESSIONS(ID) ON DELETE CASCADE';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/
