-- ODL Secondary Shadow Schema (non-breaking, additive)
-- Safe to run multiple times.

DECLARE
    e_exists EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_exists, -955); -- ORA-00955 name is already used
BEGIN
    EXECUTE IMMEDIATE q'[
        CREATE TABLE TOMEHUB_CONTENT_ODL_SHADOW (
            ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
            FIREBASE_UID VARCHAR2(128 CHAR) NOT NULL,
            ITEM_ID VARCHAR2(128 CHAR) NOT NULL,
            TITLE VARCHAR2(1000 CHAR),
            CONTENT_CHUNK CLOB NOT NULL,
            PAGE_NUMBER NUMBER,
            CHUNK_INDEX NUMBER,
            NORMALIZED_CONTENT CLOB,
            LEMMA_TOKENS CLOB,
            TOKEN_FREQ CLOB,
            CONTENT_HASH VARCHAR2(64 CHAR),
            ODL_VERSION VARCHAR2(128 CHAR),
            POSTPROCESS_VERSION VARCHAR2(64 CHAR),
            QUALITY_METRICS_JSON CLOB,
            CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ]';
EXCEPTION
    WHEN e_exists THEN NULL;
END;
/

DECLARE
    e_exists EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_exists, -955);
BEGIN
    EXECUTE IMMEDIATE q'[
        CREATE INDEX IX_ODL_SHADOW_UID_ITEM
        ON TOMEHUB_CONTENT_ODL_SHADOW (FIREBASE_UID, ITEM_ID)
    ]';
EXCEPTION
    WHEN e_exists THEN NULL;
END;
/

DECLARE
    e_exists EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_exists, -955);
BEGIN
    EXECUTE IMMEDIATE q'[
        CREATE INDEX IX_ODL_SHADOW_HASH
        ON TOMEHUB_CONTENT_ODL_SHADOW (CONTENT_HASH)
    ]';
EXCEPTION
    WHEN e_exists THEN NULL;
END;
/

DECLARE
    e_exists EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_exists, -955);
BEGIN
    EXECUTE IMMEDIATE q'[
        CREATE TABLE TOMEHUB_ODL_SHADOW_STATUS (
            FIREBASE_UID VARCHAR2(128 CHAR) NOT NULL,
            ITEM_ID VARCHAR2(128 CHAR) NOT NULL,
            PDF_CHECKSUM VARCHAR2(64 CHAR) NOT NULL,
            ODL_VERSION VARCHAR2(128 CHAR) NOT NULL,
            STATUS VARCHAR2(24 CHAR) NOT NULL,
            CHUNK_COUNT NUMBER DEFAULT 0,
            ERROR_TEXT CLOB,
            UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            CONSTRAINT PK_ODL_SHADOW_STATUS PRIMARY KEY (FIREBASE_UID, ITEM_ID, PDF_CHECKSUM, ODL_VERSION)
        )
    ]';
EXCEPTION
    WHEN e_exists THEN NULL;
END;
/

DECLARE
    e_exists EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_exists, -955);
BEGIN
    EXECUTE IMMEDIATE q'[
        CREATE INDEX IX_ODL_SHADOW_STATUS_STATE
        ON TOMEHUB_ODL_SHADOW_STATUS (STATUS, UPDATED_AT)
    ]';
EXCEPTION
    WHEN e_exists THEN NULL;
END;
/
