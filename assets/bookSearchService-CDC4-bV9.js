const k=new Map;function u(r){return r.trim().toLocaleLowerCase("tr-TR").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\u0131/g,"i").replace(/\s+/g," ")}function m(r){return u(r).split(" ").map(t=>t.trim()).filter(t=>t.length>=2)}function b(r){return r.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[\u00e7\u00c7]/g,"c").replace(/[\u011f\u011e]/g,"g").replace(/[\u0131\u0130]/g,"i").replace(/[\u00f6\u00d6]/g,"o").replace(/[\u015f\u015e]/g,"s").replace(/[\u00fc\u00dc]/g,"u")}function S(r){const t=new Set,n=u(r),e=m(n);if(!e.length)return[];const o={etik:["ethics","ethic"],ahlak:["ethics","morality"],kotuluk:["evil"],kavrayisi:["understanding"],uzerine:["on"],deneme:["essay"],felsefesi:["philosophy"],felsefe:["philosophy"]},a=e.map(s=>o[s]&&o[s][0]?o[s][0]:s);return a.join(" ")!==e.join(" ")&&t.add(a.join(" ")),e.includes("badiou")&&(e.includes("etik")||e.includes("ahlak"))&&(t.add("alain badiou ethics"),t.add("ethics alain badiou"),t.add("ethics an essay on the understanding of evil alain badiou")),Array.from(t)}function L(r){const t=new Set,n=u(r),e=m(r);if(t.add(r),t.add(n),t.add(b(r)),t.add(b(n)),S(r).forEach(o=>t.add(o)),e.length>=3){const o=`${e[e.length-2]} ${e[e.length-1]}`,a=e.slice(0,-2).join(" ");t.add(`${o} ${a}`),t.add(`intitle:${a} inauthor:${o}`),t.add(`inauthor:${o}`)}return Array.from(t).map(o=>u(o)).filter(o=>!!o)}function I(r){const t=new Set;t.add(r),t.add(b(r));const n={ç:"c",ğ:"g",ı:"i",ö:"o",ş:"s",ü:"u",Ç:"C",Ğ:"G",İ:"I",Ö:"O",Ş:"S",Ü:"U","Ã§":"c",ÄŸ:"g","Ä±":"i","Ã¶":"o",ÅŸ:"s","Ã¼":"u","Ã‡":"C",Äž:"G","Ä°":"I","Ã–":"O",Åž:"S",Ãœ:"U"};let e=r;for(const[o,a]of Object.entries(n))e=e.replace(new RegExp(o,"g"),a);return e!==r&&t.add(e),Array.from(t).slice(0,8)}function $(r,t){const n=[];for(let e=0;e<=t.length;e++)n[e]=[e];for(let e=0;e<=r.length;e++)n[0][e]=e;for(let e=1;e<=t.length;e++)for(let o=1;o<=r.length;o++)t.charAt(e-1)===r.charAt(o-1)?n[e][o]=n[e-1][o-1]:n[e][o]=Math.min(n[e-1][o-1]+1,n[e][o-1]+1,n[e-1][o]+1);return n[t.length][r.length]}function y(r,t){const n=u(r),e=u(t);if(!n||!e)return 0;if(n===e)return 1;if(e.includes(n))return .9;const o=Math.max(n.length,e.length);return o===0?0:1-$(n,e)/o}function w(r,t){const n=m(r),e=m(t);if(!n.length||!e.length)return 0;const o=new Set(e);return n.filter(s=>o.has(s)).length/n.length}function R(r,t){const n=u(r),e=m(r),o=t.map(s=>{const l=s.title||"",i=s.author||"",p=y(n,l),c=y(n,i),h=w(n,l),f=w(n,i),g=e.length>=2&&f>=.5,d=Math.max(p*.45+h*.45+f*.1,c*.6+f*.4)+(g?.1:0);return{result:s,score:d}}),a=o.filter(s=>s.score>=.1);return a.length===0?(o.sort((s,l)=>l.score-s.score),o.slice(0,5).map(s=>s.result)):(a.sort((s,l)=>l.score-s.score),a.map(s=>s.result))}function j(r){const t=new Set,n=[];for(const e of r){const o=`${u(e.title)}|${u(e.author)}`;t.has(o)||(t.add(o),n.push(e))}return n}async function C(r){try{const t=L(r).flatMap(I),n=[];let e=!1;for(const a of t){const s=`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(a)}&maxResults=10`;try{const l=await fetch(s);if(!l.ok){(l.status===503||l.status===429)&&console.warn(`Google Books throttled/unavailable (${l.status})`);continue}const i=await l.json();if(!i.items)continue;const p=i.items.map(c=>{var h,f,g,d;return{title:c.volumeInfo.title||"",author:((h=c.volumeInfo.authors)==null?void 0:h[0])||"Unknown",publisher:c.volumeInfo.publisher||"",isbn:((g=(f=c.volumeInfo.industryIdentifiers)==null?void 0:f[0])==null?void 0:g.identifier)||"",translator:"",tags:c.volumeInfo.categories||[],summary:c.volumeInfo.description||"",publishedDate:c.volumeInfo.publishedDate||"",url:c.volumeInfo.infoLink||"",coverUrl:((d=c.volumeInfo.imageLinks)==null?void 0:d.thumbnail)||null,pageCount:c.volumeInfo.pageCount||void 0,sourceLanguageHint:c.volumeInfo.language||void 0}});if(n.push(...p),e=!0,n.length>=10)break}catch(l){console.warn(`Google Books fetch failed for variant "${a}":`,l)}}if(e&&n.length>0)return n;console.warn("Google Books failed or returned no results, trying OpenLibrary fallback...");const o=await v(r);return o.length>0?(console.log("OpenLibrary fallback succeeded"),o):n}catch(t){console.error("Google Books error:",t);try{const n=await v(r);if(n.length>0)return console.log("OpenLibrary fallback succeeded"),n}catch(n){console.error("OpenLibrary fallback also failed:",n)}return[]}}async function v(r){try{const t=L(r).flatMap(I),n=[];for(const e of t){const o=`https://openlibrary.org/search.json?q=${encodeURIComponent(e)}&limit=10`,a=await fetch(o);if(!a.ok)continue;const s=await a.json();if(!s.docs||s.docs.length===0)continue;const l=s.docs.map(i=>{var p,c,h,f,g,d;return{title:i.title||"",author:((p=i.author_name)==null?void 0:p[0])||"Unknown",publisher:((c=i.publisher)==null?void 0:c[0])||"",isbn:((h=i.isbn)==null?void 0:h[0])||"",translator:"",tags:((f=i.subject)==null?void 0:f.slice(0,5))||[],summary:"",publishedDate:((g=i.first_publish_year)==null?void 0:g.toString())||"",url:`https://openlibrary.org${i.key}`,coverUrl:i.cover_i?`https://covers.openlibrary.org/b/id/${i.cover_i}-M.jpg`:null,pageCount:i.number_of_pages_median||i.number_of_pages||void 0,sourceLanguageHint:((d=i.language)==null?void 0:d[0])||void 0}});if(n.push(...l),n.length>=15)break}return n}catch(t){return console.error("Open Library error:",t),[]}}async function z(r){if(!r.trim())return{results:[],source:"google-books",cached:!1};const t=u(r),n=`search:${t}`;if(k.has(n))return{...k.get(n),cached:!0};const[e,o]=await Promise.all([C(t),v(t)]),a=[...e,...o],s=j(a),i={results:R(r,s).slice(0,10),source:e.length>0?"google-books":"open-library",cached:!1};return k.set(n,i),i}export{z as searchBooks};
