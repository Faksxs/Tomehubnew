const k=new Map;function m(o){const n=o.replace(/[-\s]/g,"");return(n.length===10||n.length===13)&&/^\d+X?$/i.test(n)}function u(o){return o.trim().toLocaleLowerCase("tr-TR").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\u0131/g,"i").replace(/\s+/g," ")}function b(o){return u(o).split(" ").map(n=>n.trim()).filter(n=>n.length>=2)}function v(o){return o.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[\u00e7\u00c7]/g,"c").replace(/[\u011f\u011e]/g,"g").replace(/[\u0131\u0130]/g,"i").replace(/[\u00f6\u00d6]/g,"o").replace(/[\u015f\u015e]/g,"s").replace(/[\u00fc\u00dc]/g,"u")}function C(o){const n=new Set,t=u(o),e=b(t);if(!e.length)return[];const r={etik:["ethics","ethic"],ahlak:["ethics","morality"],kotuluk:["evil"],kavrayisi:["understanding"],uzerine:["on"],deneme:["essay"],felsefesi:["philosophy"],felsefe:["philosophy"]},i=e.map(l=>r[l]&&r[l][0]?r[l][0]:l);return i.join(" ")!==e.join(" ")&&n.add(i.join(" ")),e.includes("badiou")&&(e.includes("etik")||e.includes("ahlak"))&&(n.add("alain badiou ethics"),n.add("ethics alain badiou"),n.add("ethics an essay on the understanding of evil alain badiou")),Array.from(n)}function R(o){const n=new Set,t=u(o),e=b(o);if(n.add(o),n.add(t),n.add(v(o)),n.add(v(t)),C(o).forEach(r=>n.add(r)),e.length>=3){const r=`${e[e.length-2]} ${e[e.length-1]}`,i=e.slice(0,-2).join(" ");n.add(`${r} ${i}`),n.add(`intitle:${i} inauthor:${r}`),n.add(`inauthor:${r}`)}return Array.from(n).map(r=>u(r)).filter(r=>!!r)}function S(o){const n=new Set;n.add(o),n.add(v(o));const t={ç:"c",ğ:"g",ı:"i",ö:"o",ş:"s",ü:"u",Ç:"C",Ğ:"G",İ:"I",Ö:"O",Ş:"S",Ü:"U","Ã§":"c",ÄŸ:"g",Äı:"i","Ã¶":"o",ÅŸ:"s","Ã¼":"u","Ã‡":"C",Äž:"G","Ä°":"I","Ã–":"O",Åž:"S",Ãœ:"U"};let e=o;for(const[r,i]of Object.entries(t))e=e.replace(new RegExp(r,"g"),i);return e!==o&&n.add(e),Array.from(n).slice(0,8)}function U(o,n){const t=[];for(let e=0;e<=n.length;e++)t[e]=[e];for(let e=0;e<=o.length;e++)t[0][e]=e;for(let e=1;e<=n.length;e++)for(let r=1;r<=o.length;r++)n.charAt(e-1)===o.charAt(r-1)?t[e][r]=t[e-1][r-1]:t[e][r]=Math.min(t[e-1][r-1]+1,t[e][r-1]+1,t[e-1][r]+1);return t[n.length][o.length]}function $(o,n){const t=u(o),e=u(n);if(!t||!e)return 0;if(t===e)return 1;if(e.includes(t))return .9;const r=Math.max(t.length,e.length);return r===0?0:1-U(t,e)/r}function L(o,n){const t=b(o),e=b(n);if(!t.length||!e.length)return 0;const r=new Set(e);return t.filter(l=>r.has(l)).length/t.length}function z(o,n){const t=u(o),e=b(o),r=m(t),i=n.map(s=>{if(r&&s.isbn){const I=t.replace(/[-\s]/g,""),w=s.isbn.replace(/[-\s]/g,"");if(w.includes(I)||I.includes(w))return{result:s,score:1}}const a=s.title||"",h=s.author||"",c=$(t,a),g=$(t,h),d=L(t,a),f=L(t,h),p=e.length>=2&&f>=.5,j=Math.max(c*.45+d*.45+f*.1,g*.6+f*.4)+(p?.1:0);return{result:s,score:j}}),l=i.filter(s=>s.score>=.1);return l.length===0?(i.sort((s,a)=>a.score-s.score),i.slice(0,5).map(s=>s.result)):(l.sort((s,a)=>a.score-s.score),l.map(s=>s.result))}function O(o){const n=new Set,t=[];for(const e of o){const r=`${u(e.title)}|${u(e.author)}`;n.has(r)||(n.add(r),t.push(e))}return t}async function _(o){try{let n;m(o)?n=[`isbn:${o.replace(/[-\s]/g,"")}`]:n=R(o).flatMap(S);const t=[];let e=!1;for(const i of n){const l=`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(i)}&maxResults=10`;try{const s=await fetch(l);if(!s.ok){(s.status===503||s.status===429)&&console.warn(`Google Books throttled/unavailable (${s.status})`);continue}const a=await s.json();if(!a.items)continue;const h=a.items.map(c=>{var g,d,f,p;return{title:c.volumeInfo.title||"",author:((g=c.volumeInfo.authors)==null?void 0:g[0])||"Unknown",publisher:c.volumeInfo.publisher||"",isbn:((f=(d=c.volumeInfo.industryIdentifiers)==null?void 0:d[0])==null?void 0:f.identifier)||"",translator:"",tags:c.volumeInfo.categories||[],summary:c.volumeInfo.description||"",publishedDate:c.volumeInfo.publishedDate||"",url:c.volumeInfo.infoLink||"",coverUrl:((p=c.volumeInfo.imageLinks)==null?void 0:p.thumbnail)||null,pageCount:c.volumeInfo.pageCount||void 0,sourceLanguageHint:c.volumeInfo.language||void 0}});if(t.push(...h),e=!0,t.length>=10)break}catch(s){console.warn(`Google Books fetch failed for variant "${i}":`,s)}}if(e&&t.length>0)return t;console.warn("Google Books failed or returned no results, trying OpenLibrary fallback...");const r=await y(o);return r.length>0?(console.log("OpenLibrary fallback succeeded"),r):t}catch(n){console.error("Google Books error:",n);try{const t=await y(o);if(t.length>0)return console.log("OpenLibrary fallback succeeded"),t}catch(t){console.error("OpenLibrary fallback also failed:",t)}return[]}}async function y(o){try{let n;m(o)?n=[o.replace(/[-\s]/g,"")]:n=R(o).flatMap(S);const t=[];for(const e of n){let r=`https://openlibrary.org/search.json?q=${encodeURIComponent(e)}&limit=10`;m(o)&&(r=`https://openlibrary.org/search.json?isbn=${encodeURIComponent(e)}&limit=10`);const i=await fetch(r);if(!i.ok)continue;const l=await i.json();if(!l.docs||l.docs.length===0)continue;const s=l.docs.map(a=>{var h,c,g,d,f,p;return{title:a.title||"",author:((h=a.author_name)==null?void 0:h[0])||"Unknown",publisher:((c=a.publisher)==null?void 0:c[0])||"",isbn:((g=a.isbn)==null?void 0:g[0])||"",translator:"",tags:((d=a.subject)==null?void 0:d.slice(0,5))||[],summary:"",publishedDate:((f=a.first_publish_year)==null?void 0:f.toString())||"",url:`https://openlibrary.org${a.key}`,coverUrl:a.cover_i?`https://covers.openlibrary.org/b/id/${a.cover_i}-M.jpg`:null,pageCount:a.number_of_pages_median||a.number_of_pages||void 0,sourceLanguageHint:((p=a.language)==null?void 0:p[0])||void 0}});if(t.push(...s),t.length>=15)break}return t}catch(n){return console.error("Open Library error:",n),[]}}async function G(o){if(!o.trim())return{results:[],source:"google-books",cached:!1};const n=u(o),t=`search:${n}`;if(k.has(t))return{...k.get(t),cached:!0};const[e,r]=await Promise.all([_(n),y(n)]),i=[...e,...r],l=O(i),a={results:z(o,l).slice(0,10),source:e.length>0?"google-books":"open-library",cached:!1};return k.set(t,a),a}export{G as searchBooks};
