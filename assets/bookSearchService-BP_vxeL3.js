const $=new Map,I=20,w=20;function p(t){return t.trim().toLocaleLowerCase("tr-TR").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\u0131/g,"i").replace(/\s+/g," ")}function k(t){return p(t).split(" ").map(n=>n.trim()).filter(n=>n.length>=2)}function A(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[\u00e7\u00c7]/g,"c").replace(/[\u011f\u011e]/g,"g").replace(/[\u0131\u0130]/g,"i").replace(/[\u00f6\u00d6]/g,"o").replace(/[\u015f\u015e]/g,"s").replace(/[\u00fc\u00dc]/g,"u")}function O(t){return String(t||"").replace(/[^0-9Xx]/g,"").toUpperCase()}function L(t){if(!/^\d{9}[\dX]$/.test(t))return!1;let n=0;for(let e=0;e<10;e+=1){const r=t[e],o=r==="X"?10:Number(r);n+=o*(10-e)}return n%11===0}function U(t){if(!/^\d{13}$/.test(t))return!1;let n=0;for(let r=0;r<12;r+=1)n+=Number(t[r])*(r%2===0?1:3);return(10-n%10)%10===Number(t[12])}function N(t){if(!L(t))return null;const n=`978${t.slice(0,9)}`;let e=0;for(let o=0;o<12;o+=1)e+=Number(n[o])*(o%2===0?1:3);const r=(10-e%10)%10;return`${n}${r}`}function G(t){if(!U(t)||!t.startsWith("978"))return null;const n=t.slice(3,12);let e=0;for(let i=0;i<9;i+=1)e+=Number(n[i])*(10-i);const r=11-e%11,o=r===10?"X":r===11?"0":String(r);return`${n}${o}`}function h(t){const n=O(t);return n.length===13&&U(n)||n.length===10&&L(n)?n:null}function d(t){const n=new Set,e=h(t);if(!e)return n;if(n.add(e),e.length===10){const r=N(e);r&&n.add(r)}else if(e.length===13){const r=G(e);r&&n.add(r)}return n}function P(t){return d(t).size>0}function M(t){const n=new Set;for(const e of t||[]){const r=h(String((e==null?void 0:e.identifier)||""));r&&n.add(r)}return Array.from(n)}function R(t){const n=Array.isArray(t)?t:[],e=new Set;for(const r of n){const o=h(String(r||""));o&&e.add(o)}return Array.from(e)}function _(t,n){if(n&&n.size>0){const r=t.find(o=>n.has(o));if(r)return r}const e=t.find(r=>r.length===13);return e||t[0]||""}function v(t,n){if(n.size===0)return!1;for(const e of t)if(n.has(e))return!0;return!1}function D(t,n){var o,i;const e=(t==null?void 0:t.volumeInfo)||{},r=M(e.industryIdentifiers);return n&&n.size>0&&!v(r,n)?null:{title:e.title||"",author:((o=e.authors)==null?void 0:o[0])||"Unknown",publisher:e.publisher||"",isbn:_(r,n),allIsbns:r,translator:"",tags:e.categories||[],summary:e.description||"",publishedDate:e.publishedDate||"",url:e.infoLink||"",coverUrl:((i=e.imageLinks)==null?void 0:i.thumbnail)||null,pageCount:e.pageCount||void 0,sourceLanguageHint:e.language||void 0,_provider:"google-books"}}function x(t,n){var r,o,i,l,s;const e=R((t==null?void 0:t.isbn)||[]);return n&&n.size>0&&!v(e,n)?null:{title:(t==null?void 0:t.title)||"",author:((r=t==null?void 0:t.author_name)==null?void 0:r[0])||"Unknown",publisher:((o=t==null?void 0:t.publisher)==null?void 0:o[0])||"",isbn:_(e,n),allIsbns:e,translator:"",tags:((i=t==null?void 0:t.subject)==null?void 0:i.slice(0,5))||[],summary:"",publishedDate:((l=t==null?void 0:t.first_publish_year)==null?void 0:l.toString())||"",url:t!=null&&t.key?`https://openlibrary.org${t.key}`:"",coverUrl:t!=null&&t.cover_i?`https://covers.openlibrary.org/b/id/${t.cover_i}-M.jpg`:null,pageCount:(t==null?void 0:t.number_of_pages_median)||(t==null?void 0:t.number_of_pages)||void 0,sourceLanguageHint:((s=t==null?void 0:t.language)==null?void 0:s[0])||void 0,_provider:"open-library"}}function E(t,n){var a,u,f;const e=(t==null?void 0:t.identifiers)||{},r=R([...Array.isArray(e==null?void 0:e.isbn_13)?e.isbn_13:[],...Array.isArray(e==null?void 0:e.isbn_10)?e.isbn_10:[]]);if(n&&n.size>0&&!v(r,n))return null;const o=Array.isArray(t==null?void 0:t.publishers)?t.publishers.map(c=>String((c==null?void 0:c.name)||"").trim()).filter(Boolean):[],i=Array.isArray(t==null?void 0:t.authors)?t.authors.map(c=>String((c==null?void 0:c.name)||"").trim()).filter(Boolean):[],l=((a=t==null?void 0:t.cover)==null?void 0:a.large)||((u=t==null?void 0:t.cover)==null?void 0:u.medium)||((f=t==null?void 0:t.cover)==null?void 0:f.small)||null,s=t!=null&&t.url?`https://openlibrary.org${t.url}`:"";return{title:String((t==null?void 0:t.title)||"").trim(),author:i[0]||"Unknown",publisher:o[0]||"",isbn:_(r,n),allIsbns:r,translator:"",tags:[],summary:String((t==null?void 0:t.notes)||"").trim(),publishedDate:String((t==null?void 0:t.publish_date)||"").trim(),url:s,coverUrl:l,pageCount:Number(t==null?void 0:t.number_of_pages)||void 0,sourceLanguageHint:void 0,_provider:"open-library-bib"}}function T(t){const n=new Set,e=p(t),r=k(t);if(n.add(t),n.add(e),n.add(A(t)),n.add(A(e)),r.length>=3){const o=`${r[r.length-2]} ${r[r.length-1]}`,i=r.slice(0,-2).join(" ");n.add(`${o} ${i}`),n.add(`intitle:${i} inauthor:${o}`),n.add(`inauthor:${o}`)}return Array.from(n).map(o=>p(o)).filter(Boolean)}function j(t){const n=new Set;n.add(t),n.add(A(t));const e={ç:"c",ğ:"g",ı:"i",ö:"o",ş:"s",ü:"u",Ç:"C",Ğ:"G",İ:"I",Ö:"O",Ş:"S",Ü:"U","Ã§":"c",ÄŸ:"g",Äı:"i","Ã¶":"o",ÅŸ:"s","Ã¼":"u","Ã‡":"C",Äž:"G","Ä°":"I","Ã–":"O",Åž:"S",Ãœ:"U"};let r=t;for(const[o,i]of Object.entries(e))r=r.replace(new RegExp(o,"g"),i);return r!==t&&n.add(r),Array.from(n).slice(0,8)}function H(t,n){const e=[];for(let r=0;r<=n.length;r+=1)e[r]=[r];for(let r=0;r<=t.length;r+=1)e[0][r]=r;for(let r=1;r<=n.length;r+=1)for(let o=1;o<=t.length;o+=1)n.charAt(r-1)===t.charAt(o-1)?e[r][o]=e[r-1][o-1]:e[r][o]=Math.min(e[r-1][o-1]+1,e[r][o-1]+1,e[r-1][o]+1);return e[n.length][t.length]}function z(t,n){const e=p(t),r=p(n);if(!e||!r)return 0;if(e===r)return 1;if(r.includes(e))return .9;const o=Math.max(e.length,r.length);return o===0?0:1-H(e,r)/o}function B(t,n){const e=k(t),r=k(n);if(!e.length||!r.length)return 0;const o=new Set(r);return e.filter(l=>o.has(l)).length/e.length}function S(t){const n=new Set,e=[];for(const r of t){const i=(r.allIsbns||[]).map(a=>h(a)||"").filter(Boolean).sort().join(","),l=`${p(r.title)}|${p(r.author)}`,s=i||l;n.has(s)||(n.add(s),e.push(r))}return e}function V(t,n){const e=p(t),r=k(e),o=d(t);if(o.size>0){const s=n.map(a=>{const f=(a.allIsbns||[]).map(b=>h(b)||"").filter(Boolean).find(b=>o.has(b)),c=a._provider==="google-books"?.08:a._provider==="open-library-bib"?.06:.04,g=p(String(a.sourceLanguageHint||""))==="tr"?.02:0,m=(f?1:0)+c+g;return{result:a,score:m}});return s.sort((a,u)=>u.score-a.score),s.map(a=>a.result)}const i=n.map(s=>{const a=s.title||"",u=s.author||"",f=z(e,a),c=z(e,u),g=B(e,a),m=B(e,u),b=r.length>=2&&m>=.5,C=Math.max(f*.45+g*.45+m*.1,c*.6+m*.4)+(b?.1:0);return{result:s,score:C}}),l=i.filter(s=>s.score>=.1);return l.length===0?(i.sort((s,a)=>a.score-s.score),i.slice(0,5).map(s=>s.result)):(l.sort((s,a)=>a.score-s.score),l.map(s=>s.result))}async function X(t){const n=d(t),e=n.size>0,r=e?Array.from(n).map(i=>`isbn:${i}`):T(t).flatMap(j),o=[];for(const i of r){const l=`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(i)}&maxResults=${I}&printType=books`;try{const s=await fetch(l);if(!s.ok){(s.status===503||s.status===429)&&console.warn(`Google Books throttled/unavailable (${s.status})`);continue}const a=await s.json(),u=Array.isArray(a==null?void 0:a.items)?a.items:[];for(const f of u){const c=D(f,e?n:void 0);c&&o.push(c)}if(o.length>=I)break}catch(s){console.warn(`Google Books fetch failed for variant "${i}":`,s)}}return S(o)}async function Q(t){const n=[];for(const e of t){const r=`https://openlibrary.org/api/books?bibkeys=${encodeURIComponent(`ISBN:${e}`)}&format=json&jscmd=data`;try{const o=await fetch(r);if(!o.ok)continue;const i=await o.json(),l=`ISBN:${e}`,s=i==null?void 0:i[l];if(!s)continue;const a=E(s,t);a&&n.push(a)}catch(o){console.warn(`OpenLibrary bib lookup failed for ${e}:`,o)}}return S(n)}async function K(t){const n=d(t),e=n.size>0,r=e?Array.from(n):T(t).flatMap(j),o=[];if(e){const i=await Q(n);o.push(...i)}for(const i of r){const l=e?`https://openlibrary.org/search.json?isbn=${encodeURIComponent(i)}&limit=${w}`:`https://openlibrary.org/search.json?q=${encodeURIComponent(i)}&limit=${w}`;try{const s=await fetch(l);if(!s.ok)continue;const a=await s.json(),u=Array.isArray(a==null?void 0:a.docs)?a.docs:[];for(const f of u){const c=x(f,e?n:void 0);c&&o.push(c)}if(o.length>=w)break}catch(s){console.warn(`OpenLibrary fetch failed for variant "${i}":`,s)}}return S(o)}async function F(t){const n=t.trim();if(!n)return{results:[],source:"google-books",cached:!1};const e=`search:${p(n)}`;if($.has(e))return{...$.get(e),cached:!0};const r=d(n),[o,i]=await Promise.all([X(n),K(n)]);let l=S([...o,...i]);r.size>0&&(l=l.filter(f=>{const c=(f.allIsbns||[]).map(g=>h(g)||"").filter(Boolean);return v(c,r)}));const s=V(n,l).slice(0,10),a=s.some(f=>f._provider==="google-books")?"google-books":"open-library",u={results:s,source:a,cached:!1};return $.set(e,u),u}export{P as isIsbn,F as searchBooks};
